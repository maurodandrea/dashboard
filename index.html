<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Governance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h2 { margin-bottom: 10px; }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      margin-top: 20px;
    }
    select {
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
      min-width: 220px;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    select:hover, select:focus {
      border-color: #007bff;
      outline: none;
    }
    canvas {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .tabs {
      margin-top: 20px;
      border-bottom: 2px solid #007bff;
      display: flex;
      gap: 10px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      background: #e9ecef;
      user-select: none;
      transition: background 0.3s ease;
    }
    .tab.active {
      background: white;
      border-color: #007bff #007bff white #007bff;
      font-weight: bold;
      color: #007bff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <h2>Governance Dashboard</h2>

  <div class="tabs">
    <div class="tab active" data-tab="byDate">Grafico per Data</div>
    <div class="tab" data-tab="aggregated">Grafico per Prodotto</div>
    <div class="tab" data-tab="trendLines">Grafico di Tendenza</div>
  </div>

  <div id="filterContainer" style="margin-top: 20px;"></div>

  <div id="byDate" class="tab-content active">
    <canvas id="myChart" width="800" height="400"></canvas>
  </div>

  <div id="aggregated" class="tab-content">
    <canvas id="aggregateByDateChart" width="800" height="400"></canvas>
  </div>

  <div id="trendLines" class="tab-content">
    <canvas id="trendLineChart" width="800" height="400"></canvas>
  </div>

<script>
  let allData = [];
  let chartInstance = null;
  let chartAggregateByDate = null;
  let chartTrendLines = null;

  const filterContainer = document.getElementById('filterContainer');

  const dateLabel = document.createElement('label');
  dateLabel.textContent = 'Seleziona la data';
  const dateSelect = document.createElement('select');
  dateSelect.innerHTML = '<option value="">-- Seleziona una data --</option>';

  const productLabel = document.createElement('label');
  productLabel.textContent = 'Seleziona il prodotto';
  const productSelect = document.createElement('select');
  productSelect.innerHTML = '<option value="All">All</option>';

  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  function switchTab(tabName) {
    tabs.forEach(t => t.classList.remove('active'));
    tabContents.forEach(tc => tc.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(tabName).classList.add('active');

    filterContainer.innerHTML = '';
    if (tabName === 'byDate') {
      filterContainer.appendChild(dateLabel);
      filterContainer.appendChild(dateSelect);
      if (dateSelect.value) renderChartForDate(dateSelect.value);
    } else if (tabName === 'aggregated') {
      filterContainer.appendChild(productLabel);
      filterContainer.appendChild(productSelect);
      renderAggregateByDateChart();
    } else if (tabName === 'trendLines') {
      filterContainer.appendChild(productLabel);
      filterContainer.appendChild(productSelect);
      renderTrendLinesChart();
    }
  }

  tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));

  fetch('Governance_Dashboard.xlsx')
    .then(response => response.arrayBuffer())
    .then(data => {
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets['Dati'];
      allData = XLSX.utils.sheet_to_json(sheet).map(r => ({
        ...r,
        data: String(r.data).trim(),
        issue_high: +r.issue_high || 0,
        issue_medium: +r.issue_medium || 0,
        issue_low: +r.issue_low || 0
      }));

      const uniqueDates = [...new Set(allData.map(r => r.data))].sort();
      const uniqueProducts = [...new Set(allData.map(r => r.prodotto).filter(Boolean))].sort();

      dateSelect.innerHTML = '<option value="">-- Seleziona una data --</option>';
      uniqueDates.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        dateSelect.appendChild(opt);
      });
      productSelect.innerHTML = '<option value="All">All</option>';
      uniqueProducts.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p; opt.textContent = p;
        productSelect.appendChild(opt);
      });

      dateSelect.value = uniqueDates.at(-1);
      switchTab('byDate');
    });

  dateSelect.addEventListener('change', () => renderChartForDate(dateSelect.value));
  productSelect.addEventListener('change', () => {
    const currentTab = document.querySelector('.tab.active').dataset.tab;
    if (currentTab === 'trendLines') renderTrendLinesChart();
    else renderAggregateByDateChart();
  });

  // --- GRAFICO 1: Barre per data
  function renderChartForDate(selectedDate) {
    const filtered = allData.filter(r => r.data === selectedDate && r.prodotto && r.prodotto.trim() !== '');
    const labels = filtered.map(r => r.prodotto);
    const high = filtered.map(r => r.issue_high);
    const med = filtered.map(r => r.issue_medium);
    const low = filtered.map(r => r.issue_low);

    const ctx = document.getElementById('myChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'High', data: high, backgroundColor: 'rgba(255,99,132,0.7)', stack: 'stack1' },
          { label: 'Medium', data: med, backgroundColor: 'rgba(255,206,86,0.7)', stack: 'stack1' },
          { label: 'Low', data: low, backgroundColor: 'rgba(75,192,192,0.7)', stack: 'stack1' }
        ]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: `Issues per Prodotto - Data: ${selectedDate}` } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
      }
    });
  }

  // --- GRAFICO 2: Barre per data aggregata
  function renderAggregateByDateChart() {
    const selectedProduct = productSelect.value;
    const agg = {};
    allData.forEach(r => {
      if (selectedProduct !== 'All' && r.prodotto !== selectedProduct) return;
      if (!r.prodotto || !r.data) return;
      if (!agg[r.data]) agg[r.data] = { high: 0, medium: 0, low: 0 };
      agg[r.data].high += r.issue_high;
      agg[r.data].medium += r.issue_medium;
      agg[r.data].low += r.issue_low;
    });

    const dates = Object.keys(agg).sort();
    const high = dates.map(d => agg[d].high);
    const med = dates.map(d => agg[d].medium);
    const low = dates.map(d => agg[d].low);

    const ctx = document.getElementById('aggregateByDateChart').getContext('2d');
    if (chartAggregateByDate) chartAggregateByDate.destroy();

    chartAggregateByDate = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [
          { label: 'High', data: high, backgroundColor: 'rgba(255,99,132,0.7)', stack: 'stack1' },
          { label: 'Medium', data: med, backgroundColor: 'rgba(255,206,86,0.7)', stack: 'stack1' },
          { label: 'Low', data: low, backgroundColor: 'rgba(75,192,192,0.7)', stack: 'stack1' }
        ]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: selectedProduct === 'All' ? 'Issues totali per Data - Tutti i Prodotti' : `Issues totali per Data - ${selectedProduct}` } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
      }
    });
  }

  // --- GRAFICO 3: Linee di tendenza curve
  function renderTrendLinesChart() {
    const selectedProduct = productSelect.value;
    const agg = {};
    allData.forEach(r => {
      if (selectedProduct !== 'All' && r.prodotto !== selectedProduct) return;
      if (!r.prodotto || !r.data) return;
      if (!agg[r.data]) agg[r.data] = { high: 0, medium: 0, low: 0 };
      agg[r.data].high += r.issue_high;
      agg[r.data].medium += r.issue_medium;
      agg[r.data].low += r.issue_low;
    });

    const dates = Object.keys(agg).sort();
    const high = dates.map(d => agg[d].high);
    const med = dates.map(d => agg[d].medium);
    const low = dates.map(d => agg[d].low);

    const ctx = document.getElementById('trendLineChart').getContext('2d');
    if (chartTrendLines) chartTrendLines.destroy();

    chartTrendLines = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          { label: 'High', data: high, borderColor: 'rgba(255,99,132,1)', tension: 0.4, borderWidth: 2, fill: false },
          { label: 'Medium', data: med, borderColor: 'rgba(255,206,86,1)', tension: 0.4, borderWidth: 2, fill: false },
          { label: 'Low', data: low, borderColor: 'rgba(75,192,192,1)', tension: 0.4, borderWidth: 2, fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: `Grafico di Tendenza - ${selectedProduct === 'All' ? 'Tutti i Prodotti' : selectedProduct}` } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>
</body>
</html>
